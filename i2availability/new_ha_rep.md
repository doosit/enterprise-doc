## 添加应用高可用规则

在控制机管理界面，通过 应用高可用-&gt;高可用，来添加/编辑 应用高可用规则，应用高可用规则添加/编辑页面如下：

![](/assets/20190428103155.png)

![](/assets/20190428103425.png)

![](/assets/V7.028614.png)

![](/assets/20190428102735.png)

![](/assets/V7.028615.png)

![](/assets/V7.028616.png)

**基本设置**

![](/assets/20190428103155.png)

*   “规则名称”：客户命名的名称，便于管理；

*   “节点设置”：节点之间不能是同一台机器，可添加多个节点进入HA群，当定义优先级相同的时候设置的初始主节点才有意义，否则优先级高的会成为初始主节点；


*   “自动切换”：开启自动切换时，当HA规则达到切换标准时，会自动从主节点切换为从节点；未开启时，当HA规则达到切换标准时，在界面规则状态中会提示警告信息；

*   “动态节点”：开启动态节点时，需要选择服务器池，从服务器池中选择节点；同时需要选择服务类型标签;

*   “仲裁设置”：分为不设置、磁盘仲裁和节点仲裁：
    
    * 勾选磁盘仲裁时需要设置一个仲裁磁盘;

    * 勾选节点仲裁时需要设置一个仲裁ip地址，这个仲裁ip所在的主机需要安装i2节点软件，并且i2Availability进程正常运行，在心跳线全部失效的情况下，要用到仲裁机制来判断谁能接管资源；
 
 ![](/assets/20190428103425.png)
 
*   “服务器池”：由多个节点组成的集群服务器池，在“应用高可用-服务器池”中添加;

*   “服务类型标签”：用户命名的服务名称，在“应用高可用-服务标签”中添加;
 
![](/assets/V7.028618.png)

*   “心跳线”：HA节点间的通讯模块，负责HA节点间的信息通讯，心跳的检测，HA节点之间可以定义多条UDP、TCP、ping类型心跳线，心跳使用的端口，网卡IP地址可自定义；

 **注**：现版本使用的通讯类型都为TCP，选择其他类型暂时不起作用
 
**数据同步**

![](/assets/V7.028619.png)

*   “数据同步”：设置HA规则关联的数据同步选项，在复制管理中可以看到设置的复制规则，也可以在复制管理中修改停止的复制规则，只能开启从主节点到从节点的复制规则，HA的规则状态会导致相应的关联规则的变化；

*   “创建时启动复制规则”：提交HA规则时，会自动启动主节点到从节点的复制规则；

*   “进入复制状态才允许切换”：关联的复制规则只有处于复制状态，才允许HA切换；

*   “反向规则”：勾选反向规则时，HA规则会创建两条关联的复制规则；

*   “自动启动复制规则”：勾选时，当HA切换时，会自动启动关联的复制规则；

 **注**：请确保规则中源和目标均为目录
 
![](/assets/20190428102735.png)

![](/assets/20190428113652.png)

*   “数据同步”： 在主节点中选择要同步数据的目录或文件;
*   “策略”： 由策略类型、间隔时间、任务开始时间组成;
*   “切换时同步数据”： 开启后当发生切换时自动同步数据，未开启则发生切换时等待手动同步数据; 
 
**监控对象**
     
![](/assets/V7.028620.png)

*   “监控对象”：资源监控分为主节点资源监控和从节点资源监控，监控角色选择从节点时，只能做警告处理，不会引起切换，监控对象可以选择服务、进程、内存、cpu、自定义脚本、磁盘监控的方式。选择进程监控时，可以选择填写进程的名称或者进程号。勾选失败后仅做警告时，如果监控对象出现异常，会在日志中产生警告信息，不会导致切换。可以创建多条监控对象，各个监控对象是独立的，任何一条达到切换要求，都会引起切换；

*   “失败后仅做警告”：勾选时规则动作为告警，不勾选为切换;

![](/assets/V7.028621.png)

 **注意事项：**

1、自定义脚本监控时，添加的脚本文件会定时执行一次，注意这个脚本执行的时间一定不能大于“间隔时间”* ”最大失败次数“，并且脚本必需有返回;

2、自定义脚本监控，监控结果输出文件，这个文件中如果写入的是false，则会引起切换或者警告，注意false必须为文本的头5个字符，文件中写入的为true或者其他时规则不会有任何改变;

3、脚本必须存放在主从节点指定的路径下：

Windows上，脚本的根目录为：&lt;i2Soft installation Path&gt;\scripts
Linux上，脚本的根目录为：/etc/sdata/scripts

可以在脚本根目录下，创建子目录。Windows脚本必须是以.bat或者.cmd为后缀的批处理文件；Linux脚本必须是可执行文件（必须有可执行属性）。

![](/assets/V7.028622.png)

磁盘监控如果为Windows时，在盘符选择时要添加“：“如监控C盘时，在盘符选择时添加C：

如果为Linux时，则添加的目录为此目录所在的卷组或者分区


**资源切换**

![](/assets/V7.028623.png)

*   “资源切换”：资源切换分为脚本切换资源和虚IP，资源切换脚本中当主节点资源监控非正常情况下，主节点和从节点协商中发现需要切换，主节点切换成从节点时需要释放所占有的资源会执行“释放资源执行的脚本”，从而自身将为从节点，从节点切换成主节点时需要获取资源执行“获取资源执行的脚本”，从而自身升为主节点。虚IP设置时，设置虚IP的地址，这个地址会随主节点的切换而漂移，选择的网卡即是这个虚IP所附属的网卡;

 **注意：**

脚本在主节点和从节点上必须是同时存在的，并且放在指定的目录下，Windows上，脚本的根目录为：`i2Soft installation Path`\scripts

Linux上，脚本的根目录为：/etc/sdata/scripts

可以在脚本根目录下，创建子目录。Windows脚本必须是以.bat或者.cmd为后缀的批处理文件；Linux脚本必须是可执行文件（必须有可执行属性）。

虚IP配置如下：

![](/assets/V7.028624.png)



## 添加应用高可用规则

在控制机管理界面，通过 高可用管理-&gt;应用高可用，来添加/编辑 应用高可用规则，应用高可用规则添加/编辑页面如下：

![](/assets/ha_new12.png)

![](/assets/ha_new_14.png)

![](/assets/ha_new_15.png)

* 规则名称”：客户命名的名称，便于管理；

* “节点设置”：节点之间不能是同一台机器，可添加多个节点进入HA群，当定义优先级相同的时候设置的初始主节点才有意义，否则优先级高的会成为初始主节点

  **注**：暂只支持两个节点间做HA，多节点支持后续版本中支持

* “自动切换”：勾选自动切换时，当HA规则达到切换标准时，会自动从主节点切换为从节点；不勾选时，当HA规则达到切换标准时，在界面规则状态中会提示警告信息；

* “单点启动”：如果选中，节点重启时，会判断当前节点重启前是否为主节点，如果是主节点，那该节点会等待“等待时间”所配置的时间，如果确认主节点已经切换到了另一节点，那么该节点会切换为从节点。  
  如果超过所配置的等待时间后，仍然无法连接备机，无法确认备机是否已经切换为主节点，则该节点切换为主节点。当机器重启之前为从节点，并且达到就绪状态，当超出配置的等待时间，仍然连不上主节点，则能自动成为主节点。 如果从节点不是就绪状态，则即使达到条件，也不能自动成为主节点。

  该配置项主要为了解决主从节点先后宕机后，单节点启动的情况。如果单点启动没有勾选，当主从节点先后宕机后，单节点启动时，因为无法确认另外的节点是否为主节点，该节点不会切换为主节点。

![](/assets/V6.028713.png)

* “心跳线”：HA节点间的通讯模块，负责HA节点间的信息通讯，心跳的检测，HA节点之间可以定义多条心跳线，心跳使用的端口，网卡，ip地址可自定义；

![](/assets/V6.118042618.png)

* “数据同步”：设置HA规则关联的数据同步选项，在复制管理中可以看到设置的复制规则，也可以在复制管理中修改停止的复制规则，只能开启从主节点到从节点的复制规则，HA的规则状态会导致相应的关联规则的变化。

* “反向规则”：勾选反向规则时，HA规则会创建两条关联的复制规则

* “创建时启动复制规则”：提交HA规则时，会自动启动主节点到从节点的复制规则

* “进入复制状态才允许切换”：关联的复制规则只有处于复制状态，才允许HA切换

* “自动启动复制规则”：勾选时，当HA切换是，会自动启动关联的复制规则

  **注意**：请确保规则中源和目标均为目录。

![](/assets/V6.1.2018122402.png)

* “监控角色”：资源监控分为主节点资源监控和从节点资源监控，监控角色选择从节点时，只能做告警处理，不会引起切换，监控对象可以选择服务、进程、内存、cpu、自定义脚本、磁盘监控的方式。选择进程监控时，可以选择填写进程的名称或者进程号。勾选失败后仅记日志时，如果监控对象出现异常，会在日志中产生告警信息，不会导致切换。可以创建多条监控对象，各个监控对象是独立的，任何一条达到切换要求，都会引起切换；

* “失败后仅记日志”：勾选此选项，资源监控失败时仅记录日志，不会导致切换。

![](/assets/V6.1.2018122403.jpg)

**注意：**

```
1、自定义脚本监控时，添加的脚本文件会定时执行一次，注意这个脚本执行的时间一定不能大于“间隔时间”* ”最大失败次数“，并且脚本必需有返回
2、自定义脚本监控，监控结果输出文件，这个文件中如果写入的是false，则会引起切换或者警告，注意false必须为文本的头5个字符，文件中写入的为true或者其他时规则不会有任何改变
3、脚本必须存放在主从节点指定的路径下，Windows上，脚本的根目录为：
\i2Soft installation Path\scripts
Linux上，脚本的根目录为：/etc/sdata/scripts
可以在脚本根目录下，创建子目录。Windows脚本必须是以.bat或者.cmd为后缀的批处理文件；Linux脚本必须是可执行文件（必须有可执行属性）。
```

![](/assets/V6.029575.png)

```
磁盘监控如果为windows时，在盘符选择时要添加“：“如监控C盘时，在盘符选择时添加C：

如果为linux时，则添加的目录为此目录所在的卷组或者分区
```

![](/assets/V6.029666.png)

* “资源切换”：资源切换分为脚本切换资源和虚ip，资源切换脚本中当主节点资源监控非正常情况下，主节点和从节点协商中发现需要切换，主节点切换成从节点时需要释放所占有的资源会执行“释放资源执行的脚本”，从而自身将为从节点，从节点切换成主节点时需要获取资源执行“获取资源执行的脚本”，从而自身升为主节点。

        虚ip设置时，设置虚ip的地址，这个地址会随主节点的切换而漂移，选择的网卡即是这个虚ip所附属的网卡。如果顺序执行选项选    中，HA资源切时，会严格按照资源配置的先后顺序执行，虚IP的添加会尝试指定的次数。需要注意的是，由于Windows系统的机制限制，Windows 附加IP后会有 2 秒的延迟，如果服务依赖虚IP， 启动时需要在脚本中先判断是否虚IP是否已经加载上，虚IP地址存在后再往下执行。如果顺序执行选项没有选中，虚IP的添加过程和脚本切换可能是并行执行的，无法绝对保证顺序执行。

**注意：**

    脚本在主节点和从节点上必须是同时存在的，并且放在指定的目录下，Windows上，脚本的根目录为：`i2Soft installation Path`\scripts

    Linux上，脚本的根目录为：/etc/sdata/scripts

    可以在脚本根目录下，创建子目录。Windows脚本必须是以.bat或者.cmd为后缀的批处理文件；Linux脚本必须是可执行文件（必须有可执行属性）。

    虚ip配置如下：

![](/assets/ha_vip.png)

![](/assets/V6.030077.png)

* 仲裁设置：当前只支持节点仲裁

使用节点仲裁时需要设置一个仲裁ip地址，这个仲裁ip所在的主机需要安装i2节点软件，并且i2Availability进程正常运行，在心跳线全部失效的情况下，要用到仲裁机制来判断谁能接管资源

提交规则后会提示确认信息，确认HA规则配置是否正确，确认完成后，提交规则

![](/assets/V6.118042620.png)


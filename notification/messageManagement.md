## 消息接收管理

用户可以通过“消息通知管理”，来选择相应的模块是否接收站内信息、邮件信息或者手机短信，并通过“保存配置”按钮，将配置进行保存

![](/assets/v7.0.20181114003.png)

点击“巡检通知”右侧的“设置”键，可以设置巡检通知的策略和通知的日期：

*  “巡检提醒通知策略”： 按月或者按季度发送巡检提醒通知

*  “巡检提醒”： 表示每月或者每个季度的用户输入的第1,3,5,7天发送巡检提醒

如下图：

![](/assets/v7.0.20181114004.png)

点击“整体状态”右侧的“设置”键，可以设置整体状态通知的策略以及通知的间隔

*  整体状态通知策略:  按小时或者按天发送整体状态通知

*  通知间隔： 为数字，表示每隔n小时或者n天发送整体状态通知

如下图：

![](/assets/v7.0.20181114005.png)

通过“更多设置” 可以设置：

*  通知次数限制： 用户会收到的消息次数

*  重置通知次数： 重置用户收到的消息次数（如果通知次数限制是5，已经发了3次，此时重置通知次数，已发次数清0，消息会重新发送5次）

*  修改联系人： 包括当前用户、普通联系人、巡检通知联系人、整体状态联系人的联系人手机以及邮箱

![](/assets/v7.0.20181114006.png)

## 短信模板说明

### 短信模板设置

* 勾选“短信”时，短信模板设置为可选状态，点击此键可以在弹出的对话框设置 **每个模块** 的短信模板；

![](/assets/v7.1.20190618164552.png)

* 对于 阿里、华为、东方证券平台：短信模板为必填，内容为模板ID，配置方式见下文 **华为消息通知服务**。

* 对于 其他平台：此项为可选，填短信模板全文，如不填则默认用内置模板发送短信。

* 以图中巡检通知为例：

    * 假设要发送的短信内容是：${username}你好，设置的（${time}）定时巡检提醒时间到了，请安排巡检。

    * 如果是需要在平台上配置模板的短信平台，如阿里：

        1. 先去阿里短信平台的网站上配置模板，并获取到模板ID。

        2. 将模板ID填到这里。

    * 如果是不需要在短信平台上配置模板的，如企信王：

        1. 这里直接填自定义短信格式，如“${username}你好，设置的（${time}）定时巡检提醒时间到了，请安排巡检”。

    * 配置正常则会在设定的时间收到短信：admin 你好，设置的（2019-1-1 11:11）定时巡检提醒时间到了，请安排巡检。

    * 注：无论是在这里填模板全文，还是从短信平台获取的模板ID，其模板内容都需要包含必需的变量，如巡检通知需要包含${username}、${time}两个变量，每个模板所需的变量，会在设置变量时提示（如上图所示）。

### 模板变量说明：

* 通用参数：

    * ${username}：用户名，即节点/规则的创建者。
    * ${module}：模块名称，如“复制规则”。
    * ${name}：节点/规则的名称。
    * ${status}：节点/规则的状态。
    * ${time}：短信发送的时间 / 巡检通知设定的时间。

* 资源管理（节点/虚拟平台/集群）：

    * ${config_addr}：管理地址。
    * ${data_addr}：数据地址。

* 规则/任务相关的资源（x代指资源序号，0-3）：

    * ${res_type_x}：资源类型。
    * ${res_name_x}：资源名称。
    * ${res_status_x}：资源状态。
    * ${config_addr_x}：资源管理地址。
    * ${data_addr_x}：资源配置地址。
    * ${vm_name}：虚拟平台规则相关的虚机名称。
    * ${tips}：高可用规则的提示语。

* 整体状态：

    *  ${node}, ${vp}, ${cls}, ${rep_backup}, ${nas}, ${fsp_backup}, ${fsp_move},
       ${vp_backup}, ${vp_recovery}, ${vp_move}, ${vp_rep}, ${timing_backup}, ${ha},
    * 这些参数为整体状态各个模块的正常/异常计数，如 3/2 意为 正常 3个，不正常 2个。

* 告警通知：

    * ${username}：规则所属用户。
    * ${name}：规则名称。
    * ${module}：规则所属模块。
    * ${msg}：规则状态信息。
    * ${time}：当前控制机时间。

* 存储监控：

    * ${username}：节点所属用户。
    * ${bk_node_name}：节点名称。
    * ${bk_ip}：节点IP。
    * ${name}：存储设备名称，如C:。
    * ${dev_used_percent}：当前已用容量百分比。
    * ${threshold}：告警阈值百分比。
    * ${time}：当前控制机时间。

### 华为消息通知服务

华为消息通知服务，不是简单的SMS服务。需要先创建一个主题，所有的应用都可以发消息给这个主题，主题会通知到“订阅者”；所以和企业版现有的控制台的SMS以及通知有点不一样，需要在华为的控制台里创建主题并添加订阅。

如下是**华为消息通知服务**设置的主要步骤：

* 先创建一个主题：

    ![](/assets/CatchB8B5%2805-28-18-30-30%29.jpg)

    ![](/assets/Catch0294%2805-28-18-30-30%29.jpg)

* 再创建一个模板，类型选择短信；华为要求同时创建一个协议为Default的同名的模板：

    ![](/assets/Catch8F04%2805-28-18-30-30%29.jpg)

* 再添加订阅，这里协议可以选择短信和邮件以及其他的：

    ![](/assets/Catch0294%2805-28-18-30-30%29.jpg)

### 阿里云消息通知服务

如下是具体的appkey、SecretKey获取:

![](/assets/V6.118042602.png)

如下是签名名称、短信模板ID:

![](/assets/V6.118042603.png)

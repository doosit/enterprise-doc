## 全服务器备份

### 备份规则的配置和启动 {#-0}

通过控制机管理界面，全服务器保护-&gt;全服务器备份，来添加/编辑服务器任务，全服务器备份任务添加/编辑页面如下：

![](/assets/V7.030946.png)

点击“新建”按钮，进入全服务器备份规则定义界面：

![](/assets/V7.030974.png)

* “名称”:客户命名的名称，便于管理；

* “工作机”：指定全服务器备份的主机；

* “灾备机”：指定全服务器备份的备机；

* “同步项”: 用户自定义选择要同步的磁盘，比如：C: ,E:\,F:\;

* “源类型”：分为块设备和文件两种；

* “目标类型”：若源类型是文件，则目标类型有文件和vmdk两种；若源类型是块设备，则目标类型有raw、qcow和vmdk三种（注：若源类型选择块设备，则工作机只能为Windows且文件系统为NTFS。此时当备机是Windows时，目标类型可选raw和vmdk；当备机为Linux时，目标类型可选raw、qcow和vmdk）；

* “工作机源目录和文件”: 要复制到灾备机的数据（注：不可自定义）；

* “灾备机目标路径“：数据要备份到灾备机上的路径；

* “不要复制的目录和文件”：除了系统定义的之外，用户可以自定义不需要复制的目录和文件。

### 镜像设置 {#mirr}

* [复制规则高级属性](/coopy_cdp/advance_settings.md)

### 压缩加密 {#comp}

* [复制规则高级属性](/coopy_cdp/advance_settings.md)

### 备份策略 {#auto}

开启自动备份，可以在用户设定的时间，自动备份设定的数目。
![](/assets/V7.034447.png)

* “立刻执行”：立刻开启备份

* “一次性任务”：指定时间开启任务

* “周期性任务”：设置一个循环执行计划（注：当源类型和目标类型都是文件时，周期性任务只支持全备；其它源类型和目标类型的组合均支持全备、增量和差异备份）


### 带宽设置 {#bw}

* [复制规则高级属性](/coopy_cdp/advance_settings.md)

设置完成后，点击“提交”后会出现“全服务器备份或还原检查”窗口（注：有时由于工作机上的文件数量过多，不能在规定的时间内将磁盘空间检查的结果通过rpc返回给控制机，就会返回“远程调用失败，连接不上节点或平台”，这时如果用户可以肯定备机的空间是足够的，则可以打开下图中的忽略按钮，来跳过此项检查提交规则）：

![](/assets/V7.1hulue.PNG)

点击”提交“后在备份规则管理界面可看到刚建立的全服务器备份规则：

![](/assets/V7.031255.png)



### 任务监控和全服务器备份 {#-1}

全服务器任务首先会将数据一次性同步到灾备机上，此过程称为镜像，镜像时间的长短取决于初始数据的大小、网络的速度以及镜像的算法，在状态栏会显示镜像的进度。

![](/assets/V7.031255.png)

全服务器备份任务对应的操作如下，第一排从左到右依次;

* “启动”：启动任务;
* “停止”：停止任务;
* “删除”：删除任务；
* “查看”：查看任务；
* “查看数据流量”：查看实时数据流量图
* “查看日志”：查看日志
* “结束备份”：当规则状态为备份就绪时，用户可以点击该图标结束备份。
* “还原“：只有状态为备份完成时才可以点击

当镜像完成后，规则进入’备份就绪’状态，如下：

![](/assets/V7.032549.png)

点击“结束备份“，规则状态变为“备份完成”，如下：

![](/assets/V7.032607.png)

点击还原按钮，进入全服务器还原配置界面，如下：

![](/assets/V7.032633.png)

综上所述，全服务器迁移任务的状态转换过程如下：

![](/assets/V6.032659.png)

### VMDK备份操作说明 {#vmdk}

创建全服务器备份规则时，再勾选vmdk之前先要确保在备机进行相应的操作使备机支持vmdk，并且装有Vmware workstation虚拟软件

**Windows备份环境：**

1. .X64环境\(windows 2008及以上版本\)

2. 直接安装info2soft-i2node-*-fori2vp(x64)软件包，安装完成后在C:\Program Files (x86)\info2soft-i2node\bin目录下，点击vstor2install.bat(最好通过cmd命令执行，这样能看到执行结果是否正常)，安装驱动。重启节点

3. 创建C:\Program Files (x86)\info2soft-i2node\vmdk\Windows 文件夹，将模板文件放置在此文件夹下，模板在192.168.83.201上的vmdk文件夹下（注意：7.1版本要将模板文件的名字中的“_V”去掉，详见存放模板的文件夹下的Readme）

**注意：**

如果是多个磁盘的vmdk备份，将windows模板（_.vmdk文件）中的Windows Server.vmdk放在C:\Program Files \(x86\)\info2soft-i2node\vmdk\Windows目录下，当备份完成后，打开虚拟机前需要将_-1.vmdk、\*-2.vmdk，依次数字序挂载到虚拟机上。此文件在在规则配置为不勾选备端拉起时，也需要拷贝到目录下。

**Linux工作机要求：**

1. 工作机至少包含/ 和/boot两个独立分区

**Linux备机环境：**


1. 创建/usr/local/sdata/vmdk/CentOS/目录并将centos模板（*.vmdk文件）放在该目录下（注意：若规则配置为不勾选备端拉起，则要拷贝CentOS.vmdk文件到目录下）。

2. 打开终端或xshell，先安装i2node节点包，然后进行i2vp_plugin的安装，如下图所示：

![](/assets/V6.118042624.png)

3. 修改 /etc/sdata/vdl.conf，在第一行的tmpDirectory前加“#”号，目的是将i2vp指定挂载路径注释掉，如下图所示：

![](/assets/V6.118042701.png)

4. 重启i2node服务，使其生效。



**注意：**

如果工作机分区，除了/boot、 / 、swap 分区之外。还有其他分区，创建vmdk备份规则的时候，可以选择添加该分区，例如home分区（添加分区的步骤:添加-&gt;手动输入/home/,并且要保持格式一致。）；

也可以选择不添加该分区，这样备份时只是把它当成普通的目录处理。当备份完成后，打开虚拟机前需要将_-1.vmdk 、_-2.vmdk等，依照数字次序挂载到虚拟机上。

### VMDK备份文件使用说明 {#vmdk-0}

1. 创建全服务器备份规则（源类型为文件，目标类型为vmdk），可打开支持备端拉起选项。勾选支持备端拉起选项支持的操作系统为：①若工作机为windows操作系统，则备机只能是windows操作系统②若工作机为Linux操作系统，则备机只能为Linux操作系统；不勾选支持备端拉起选项支持的操作系统为：①若工作机为windows操作系统，则备机可是windows操作系统或Linux操作系统②若工作机为Linux操作系统，则备机只能为Linux操作系统。下文的vmdk文件说明就是勾选此选项之后所得的备份数据的说明，可以当做虚拟机打开。而不勾选支持备端拉起所备份的数据无法当做虚拟机打开，只能通过还原方法使用（注：工作机为Windows，备机为Linux时，源类型为文件，目标类型为vmdk，不能勾选支持备端拉起选项）。具体步骤见7.1.1

![](/assets/V7.139164.PNG)
2.  备份完成后，规则为“备份完成”的状态

![](/assets/V7.032607.png)
3.  备机在C:\33BACKUP\目录下会生成vmdk文件，将其.vmdk和.vmx文件拷贝出来并用VMware Workstation打开

![](/assets/V6.032800.png)

如图，拷贝完成后，双击.vmx文件（前提是当前系统已安装VMware Workstation）

![](/assets/V6.032850.png)

点击开启虚拟机

![](/assets/V6.032861.png)

打开后你会发现，这就是你备份的那台工作机

![](/assets/V6.032885.png)


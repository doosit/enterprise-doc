## 虚机迁移

### 添加迁移规则 {#-0}

控制机管理界面，通过 虚拟化支持-&gt;虚机迁移，来添加/查看迁移规则，迁移规则添加/查看页面如下：

![说明: 1](/assets/V7.1.2019011509.png)

*   “名称”：客户命名的保护规则名称，便于管理；
*   “源平台”：已经注册的虚拟平台；
*   “虚机名称”：所选源平台上所有虚机；
*   “灾备机”：已经注册的备机；
*   “临时目录”：保护过程中数据落盘的目录；
*   “目标平台”：已经注册的虚拟平台；
*   “数据中心”：已经注册的目标平台的数据中心；
*   “主机名称”：已经注册的目标平台主机名称；
*   “存储” ： 已经注册的目标平台的数据存储；

### 高级设置 {#-1}

在控制机管理界面，通过 虚拟化支持-&gt;虚机迁移-&gt;高级，设置页面如下：

![说明: 1](/assets/V7.120190325122515.png)

* “开启快速传输” ：利用vmware的ctk机制，只传输实际使用或改变的数据；

* “静默快照支持”： 做快照的时候，暂停虚机，保证数据连续和一致，只限制启动的虚机使用；

* “支持Lan Free”： 在LAN-FREE模式可用时，使用san方式传输；

* “删除迁移虚机” ：删除规则时迁移的目标虚机被删除；

* “开启自动迁移” ：全量迁移完成之后自动迁移，如果没有勾选此选项，在全量迁移完成之后，状态变为“迁移就绪”，此时需要用户手动点击操作栏的“开始迁移”执行增量迁移动作，如果勾选了此选项，则所有的全量迁移和增量迁移自动完成，中间无需用户手工操作；

* “开启内存快照”：做快照的时候，生成内存快照，利用内存快照，能够让迁移的虚拟机处于开机状态加相同的内存内容；开启内存快照会自动迁移，关机状态不支持内存快照，关机状态是普通快照；

注：
虚机迁移规则是一次性任务。
Hyper-V平台不支持虚机迁移。


### 带宽控制

![说明: 1](/assets/V7.1.2019011511.png)

### 迁移规则列表 {#-2}

迁移任务页面如下：

![说明: 1](/assets/V7.120190404151734.png)

迁移规则包含如下状态：

*   “启动”：迁移规则开始启动；
*   “排队中”：任务正在排队；
*   “创建新虚机”： 开始创建虚拟机；
*   “获取虚机配置”：获取虚拟机配置信息到备机；
*   “查询变化数据”：计算变化块并保存到备机；
*   “传输中”：显示迁移数据进度百分比；
*   “迁移就绪”：全量迁移完成，需要用户手动点击操作栏的“开始迁移”执行迁移动作；
*   “停止”：规则停止；
*   “失效”：npsvr或备机宕机出现失效状态；
*   “完成”：迁移规则完成；
*   “恢复快照”：将目标虚机转到之前创建的快照；
*   “快照清除”：目标虚机转到之前创建的快照之后，将快照移除；

关于迁移就绪的说明：

（1）迁移开始后，第一次迁移是创建新虚机和全量迁移，第一次迁移完成，状态变为迁移就绪；

（2）迁移就绪之后，点击“开始迁移”，开始第二次迁移，是增量迁移，迁移增量数据(源端增加的数据)；

针对迁移规则可用的操作，从左到右如下：

*   “启动”：启动此虚机的规则；
*   “停止”：停止此虚机的规则；
*   “删除”：删除此虚机的规则；
*   “开始迁移”：只有状态为迁移就绪状态才可以点击“开始迁移”，开始第二次迁移，是增量迁移，迁移增量数据(源端增加的数据)；
*   “查看日志”：查看此虚机的日志；
*   “查看统计信息”：查看此虚机的统计信息；

组操作栏可用操作：
*   “查看配置”：查看规则配置；
*   “查看统计信息”：查看规则的统计信息；
*   “组启动/组停止/组删除”：启动，停止，删除组规则；



**注意**：

*  可根据客户需求可自行定义全局的task数量，在软件的安装目录etc目录下新建system.conf文件，编辑system.conf文件添加bk_tsk_thd=n，n指可建立全局的task数量的最大值。默认情况下，全局的task数量为8。

   备份规则 迁移规则 保护规则 恢复规则的task总和 不能大于 bk_tsk_thd 设置的值。
   
   esxi的传输量总和不能超过32M,system.conf  中  bk_tsk_thd * i2vp_transbuffer 的总数不能超过32。

*  添加无代理备份的任务数大于全局的task数量的最大值时，debugctl.exe back task查看任务状态为pending状态，如下图：

![说明: 3](/assets/V6.036973.png)

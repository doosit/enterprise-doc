## 虚机迁移

### 添加迁移规则 {#-0}

控制机管理界面，通过虚拟化支持-&gt;虚机迁移，来添加/查看/删除虚机迁移规则，迁移规则添加/查看页面如下：

### 基本设置{#-3}

![说明: 1](/assets/V6.118042709.png)

*   “名称”：客户命名的虚机迁移规则名称，便于管理；
*   “源平台”：已经注册的虚拟平台；
*   “虚拟机”：所选源平台上所有虚机；
*   “灾备机”：已经注册的备机；
*   “临时目录”:保护过程中数据落盘的目录；
*   “目标平台”:已经注册的虚拟平台
*   “数据中心”:已经注册的目标平台的数据中心；
*   “主机名称”:已经注册的目标平台主机名称；
*   “存储” ： 已经注册的目标平台的数据存储；

### 高级设置 {#-1}

在控制机管理界面，通过 虚拟化支持-&gt;虚机迁移-&gt;高级，设置页面如下：

![说明: 1](/assets/V6.118042710.png)

* “开启快速传输” ：支持cbt 默认开启快速传输；

* “支持 Lan free”： 文件传输的方式；

* “开启静默快照”： 做快照的时候，暂停虚机，保证数据连续和一致，只限制与启动的虚机使用

*   “删除虚拟机” ： 删除规则是迁移的虚机被删除；

*   “开启自动迁移” ：数据备份完成之后规则自动迁移

* “允许关闭源虚机” ：迁移完成后，关闭源虚机

注：保护规则可以连续，迁移规则是一次性任务。

### 保护规则列表 {#-2}

迁移任务页面如下：

![说明: 1](/assets/V6.146007.png)

保护规则包含如下状态：

*   “启动”：迁移规则开始启动；
*   “准备中”： 开始进行迁移任务
*   “创建虚拟机中” ： 开始创建虚拟机
*   “备份虚拟机配置”：备份虚拟机配置信息到备机；
*   “查询变化数据”：计算变化块并保存到备机；
*   “迁移中”：迁移规则备份数据中；
*   “迁移就绪” ： 全量迁移完成；
*   “已迁移” ： 点击迁移按钮会对变化的数据在做一次迁移
*   “停止”：规则停止；
*   “未知”：npsvr或备机宕机出现未知状态；
*   “完成”：迁移规则完成；

针对备份规则可用的操作，从左到右如下：

*   “查看”：查看规则；
*   “启动”：启动规则；
*   “停止”：停止规则；
*   “删除”：修改规则；
*   “迁移”：迁移规则；


**注意**

1. 可根据客户需求可自行定义全局的task数量，在软件的安装目录etc目录下新建system.conf文件，编辑system.conf文件添加bk\_tsk\_thd=n，n指可建立全局的task数量的最大值。默认情况下，全局的task数量为8.
2. 添加无代理备份的任务数大于全局的task数量的最大值时，debugctl.exe back task查看任务状态为pending状态，如下图：
![说明: 3](/assets/V6.036973.png)

3. 控制机管理界面pending状态任务显示如下：
![说明: 2](/assets/V6.036999.png)

4. 备份规则,迁移规则,恢复规则的task数总和不能大于bk\_tsk\_thd设置的值。

5. ESXI的传输量总和不能超过32M,system.conf 中 bk\_tsk\_thd \* i2vp\_transbuffer 的总数不能超过32.
## 虚机迁移

### 添加迁移规则 {#-0}

控制机管理界面，通过虚拟化支持-&gt;虚机迁移，来添加/查看/删除虚机迁移规则，迁移规则添加/查看页面如下：

### 基本设置{#-1}

![说明: 1](/assets/V6.120181225173011.png)

*   “名称”：客户命名的名称，便于管理；
*   “源平台”：已经注册的虚拟平台；
*   “虚拟机”：所选源平台上的虚机，被迁移的虚机；
*   “灾备机”：已经注册的灾备机；
*   “临时目录”：迁移过程中数据落盘的目录；
*   “目标平台”：已经注册的虚拟平台；
*   “目标机名称”：虚机被迁移后的名称；
*   “覆盖虚拟机”：如果目标平台有重名的虚机，则将虚机覆盖；
*   “数据中心”：已经注册的目标平台的数据中心；
*   “主机名称”：已经注册的目标平台的主机名称；
*   “存储”：已经注册的目标平台的数据存储；

### 高级设置 {#-2}

![说明: 1](/assets/V6.120181225173437.png)

* “开启快速传输” ：利用vmware的ctk机制，只传输实际使用或改变的数据；
* “支持Lan Free”：在LAN-FREE模式可用时，使用san方式传输；
* “开启静默快照”：做快照的时候，暂停虚机，保证数据连续和一致，只限制启动的虚机使用；
* “删除虚拟机 删除规则时删除迁移的虚机” ：删除规则时迁移的目标虚机被删除；
* “开启自动迁移” ：全量迁移完成之后自动迁移，如果没有勾选此选项，在全量迁移完成之后，状态变为“迁移就绪”，此时需要用户手动点击操作栏的“开始迁移”执行增量迁移动作，如果勾选了此选项，则所有的全量迁移和增量迁移自动完成，中间无需用户手工操作；
* “迁移完成后关闭源虚机” ：迁移完成后，关闭源虚机；

### 带宽控制 {#-2}

![说明: 1](/assets/V6.120181225173622.png)

![说明: 1](/assets/V6.120181225172053.png)

当在某些情况下，用户想限定备机使用的带宽，可以通过带宽控制来实现。
选定某个想要限制带宽的时间段，点击单选框“限制带宽”，跳出窗口可以选择限制的带宽范围，其中0代表停止传输，就是说在这个时间段内不传输数据，备份进度会维持在当前进度。
流量图中实时流量图计算得出的带宽，由于计算方法的原因，和这里的带宽会有误差。


### 迁移规则列表 {#-3}

迁移规则列表页面如下：

![说明: 1](/assets/V6.11811052002.png)

迁移规则包含如下状态：

* “启动”：迁移规则开始启动；
* “准备中”：开始进行迁移任务
* “创建虚机中”：开始创建虚拟机
* “备份虚拟机配置”：备份虚拟机配置信息到备机；
* “查询变化数据”：计算变化块并保存到备机；
* “迁移中”：显示迁移数据进度百分比；
* “迁移就绪”：全量迁移完成，需要用户手动点击操作栏的“开始迁移”执行迁移动作；
* “停止”：规则停止；
* “未知”：npsvr或备机宕机出现未知状态；
* “已完成”：迁移任务完成；

关于迁移就绪的说明：

（1）迁移开始后，第一次迁移是创建新虚机和全量迁移，第一次迁移完成，状态变为迁移就绪；

（2）迁移就绪之后，点击“开始迁移”，开始第二次迁移，是增量迁移，迁移增量数据(源端增加的数据)；


迁移就绪状态显示如下，此时点击操作栏的“开始迁移”执行迁移动作，直至迁移完成；
![说明: 1](/assets/V6.11811052009.png)

针对迁移规则可用的操作，从左到右如下：

*   “规则列表”：查看组内虚机列表和流量图。流量图默认展示第一条虚机的流量，当选择组内其他虚机时切换显示流量图，这里注意，选择虚机前面的复选框和流量图的显示没有关系，直接选择某一行即可切换流量图，页面如下：

![说明: 1](/assets/V6.11811052003.png)

点击“规则列表”后，操作栏按钮包含：  
启动规则：启动此虚机的规则；  
停止规则：停止此虚机的规则；

查看配置：查看此虚机的配置；

![说明: 1](/assets/V6.120181225175241.png)

删除规则：删除此虚机的规则；  
查看日志：查看此虚机的日志； 

![说明: 1](/assets/V6.11811081011.png)

*   “启动规则”：启动迁移规则；
*   “停止规则”：停止迁移规则；
*   “删除规则”：删除迁移规则；
*   “查看配置”：查看迁移规则配置，页面如下：

![说明: 1](/assets/V6.120181225175241.png)


注：

（1）如果一个虚机已经加了迁移规则，再添加其他规则时，选择虚机时，会在此虚机后标记(已迁移)，且不能再选择此虚机；

（2）在选择虚机时，鼠标移至虚拟平台名称，后面会显示出一个Refresh按钮，点击此按钮，可重新获取虚拟平台的虚机列表；

（3）虚机迁移规则是一次性任务；


**注意**

* 可根据客户需求可自行定义全局的task数量，在备机软件的安装目录etc目录下新建system.conf文件，编辑system.conf文件，添加bk\_tsk\_thd=n，n为总的最大任务并发数，默认为8，最多同时只能有8条任务在执行，包含虚机备份任务，恢复任务，迁移任务(不包含瞬时恢复任务)；
* 备机软件的安装目录etc目录下system.conf文件中的i2vp_transbuffer参数，为备机与esxi之间每次传输的数据块大小，默认是4M；
* ESXI的传输量总和不能超过32M，system.conf 中 bk\_tsk\_thd \* i2vp\_transbuffer 的总数不能超过32. 
* 添加无代理备份的任务数大于全局的task数量的最大值时，debugctl.exe back task查看任务状态为pending状态，如下图：

![说明: 3](/assets/V6.036973.png)

* 控制机管理界面pending状态任务显示如下：

![说明: 2](/assets/V6.036999.png)

* npsvr.ini配置文件中的Max\_ThreadNum\_PerHost参数，控制每个esxi主机的最大并发执行规则的数目，默认值为4，此参数受限于bk\_tsk\_thd参数的值；
* 不支持包含独立磁盘的虚机的备份；
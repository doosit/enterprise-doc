## 虚拟备份

### 添加备份规则 {#-0}

控制机管理界面，通过 虚拟化支持-&gt;虚机备份，来添加/编辑备份规则，备份规则添加/编辑页面如下：

### 基本设置{#-3}

![](/assets/V7.020190108180334.png)

*   “启用模板”：客户可以选择自己已经保存的模板，便于节省时间；
*   “名称”：客户命名的名称，便于管理；
*   “虚拟平台”：已经注册的虚拟平台；
*   “虚机名称”：所选虚拟平台上所有虚机，可同时添加多个虚拟机；
*   “灾备机”：已经注册的备机；
*   “灾备机目标路径”：选择灾备机存储备份数据的目录；   
*   “保存模板”：将已经设置好的选项保存下来，便于下次直接使用；


### 高级设置{#-3}

![](/assets/V7.020190108180517.png)

* “开启快速备份”：利用vmware的ctk机制，只传输实际使用或改变的数据，不勾选则只能进行整盘备份；

* “支持Lan Free”：在LAN-FREE模式可用时，使用san方式传输；

* “删除备份数据”：删除规则时将备份的数据删除；

* “静默快照支持”：做快照的时候，暂停虚机，保证数据连续和一致，只限制启动的虚机使用；

* “开启内存快照”：开启内存快照；

* “开启压缩设置”：开启压缩设置；


### 备份策略 {#-1}

![](/assets/V7.020190108180754.png)

* “一次性任务 开始时间”：备份一次，开始的时间；

（1） 一次任务/周期任务，任务开始运行时间以npsvr系统时间为准 ；（建议部署时将控制机和npsvr的系统时间保持一致）；

（2） 一次任务，如果开始时间早于当前时间，则立即执行；

* “周期性任务”：设置备份任务周期性执行，添加周期性任务界面

![说明: 1](/assets/V7.020190108181129.png)

* “备份周期”：范围0-64，且为整数；只针对周期性任务有效；

* “添加计划”：点击添加计划，选择策略类型，备份方式（全备，增量，差异），运行时间（可以设置多个）； 

关于备份周期的说明：

（1） 备份周期就是数据保留期限；

（2） 当天的备份任务完成之后，才开始删除过期的数据(超过数据保留期限的数据)；

（3） 如果新的备份失败，则过期的数据不删除(超过数据保留期限的数据)；

（4） 举例：数据保留0天，就是只保留今天的数据，数据保留1天，就是保留今天和昨天的数据；

（5） 举例：数据保留0周，就是保留本周的周一到周日的数据，每个周一为一周的起始，周一到周日为一周；

（6） 举例：假设数据保留0天，策略选择全备和增量备份，第2天增量备份执行完后，开始删除前一天的数据，当天增量所依赖的全备数据(前一天的)会被保留下来，当天增量所依赖的增量数据(前一天的)会被合并到第2天的第一份增量数据中；

关于全备和增量备份/差异备份策略的说明：

（1） 备份策略最多只能加2条；

（2） 不能同时添加增量备份和差异备份；

（3） 备份策略选择每周/每月/每季时，增量/差异备份的执行时间必须和全备的执行时间一致；

（4） 备份策略选择了每天，就不能再选每周/每月/每季，其他同理；

（5） 增量备份时，如果获取cbt失败，增量备份会转换为全备，差异备份也是一样；

（6） 如果第一次备份是增量备份，即增量备份先于全备执行，增量备份会转换为全备，差异备份也是一样；

（7） 针对一个备份任务，如果旧的备份还在排队中，或者还没执行完，到新的备份执行时间了，则新的这次备份任务会被略过；

### 带宽控制 {#-1}

![说明: 1](/assets/V7.020190108181743.png)

当在某些情况下，用户想限定带宽的使用，可以通过带宽控制来实现。 
选定某个想要限制带宽的时间段，点击单选框“限制带宽”，跳出窗口可以选择限制的带宽范围，其中0代表停止传输，就是说在这个时间段内不传输数据，备份进度会维持在当前进度。

### 备份规则列表 {#-2}

添加备份任务，页面如下：

![说明: 1](/assets/V7.020190108181608.png)

备份规则包含如下状态：

*   “启动”：备份规则开始启动；
*   “空闲”：非周期性备份任务，在npsvr或备机繁忙的情况下备份规则状态显示为“空闲”，周期性备份任务，在备份规则运行但没有备份数据时，备份规则状态显示为“空闲”；
*   “备份准备”：准备开始备份数据；
*   “备份虚拟机配置”：备份虚拟机配置信息到备机；
*   “查询变化数据”：计算变化块并保存到备机；
*   “检查数据”：检查备机数据的状态，是否已经存在以前备份的版本，如果没有，则初始化备份目录；如果有，返回最后备份的版本信息，新备份与旧备份建立父子关系；
*   “执行中”：备份数据中；
*   “停止”：规则停止；
*   “未知”：npsvr或备机宕机出现未知状态；
*   “完成”：数据备份完成；

针对备份规则可用的操作，从左到右如下：

*   “启动”：启动规则；
*   “停止”：停止规则；
*   “删除”：修改规则；
*   “普通恢复”：可直接添加/编辑恢复原虚机或新建虚机的恢复任务，点击普通恢复，页面如下图所示：

![说明: 1](/assets/V7.036738.png)

**注意：**

选择完备份点才能显示备份点信息。

*   “瞬时恢复”：(针对linux)可直接添加/编辑恢复原虚机或新建虚机的恢复任务
*   “查看日志”：查看规则日志；
*   “查看规则”：查看备份规则；
*   “组恢复”：可直接添加/编辑恢复原虚拟机，点击组恢复，页面如下：

![说明: 1](/assets/V7.018042708.png)

* “规则名称”：用户命名的名称，方便管理；

* “数据存放目录”：备份规则中灾备机目标路径；

* “组别名称”：备份规则名称

**注意**：

1.  可根据客户需求可自行定义全局的task数量，在软件的安装目录etc目录下新建system.conf文件，编辑system.conf文件添加bk_tsk_thd=n，n指可建立全局的task数量的最大值。默认情况下，全局的task数量为4.
2.  添加无代理备份的任务数大于全局的task数量的最大值时，debugctl.exe back task查看任务状态为pending状态，如下图：

![说明: 3](/assets/V6.036973.png)
3.  控制机管理界面pending状态任务显示如下：

![说明: 2](/assets/V7.036999.png)
4.  选择完备份点才能显示备份点信息。
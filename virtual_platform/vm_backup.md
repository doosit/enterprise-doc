## 虚机备份

### 添加备份规则 {#-0}

控制机管理界面，通过虚拟化支持-&gt;虚机备份，来添加/编辑/删除虚机备份规则，备份规则添加/编辑页面如下：

### 基本设置 {#-1}

![](/assets/V6.120181225170906.png)

* “名称”：客户命名的名称，便于管理；
* “虚拟平台”：已经注册的虚拟平台；
* “虚拟机”：所选虚拟平台上所有虚机，可同时添加多个虚拟机；
* “灾备机”：已经注册的灾备机；
* “灾备机目标路径”：选择灾备机存储备份数据的目录；

### 高级设置 {#-2}

![](/assets/V6.120181225171157.png)

* “自动设置快速备份”：默认勾选；

  （1） 如果“自动设置快速备份”选项勾选，则隐藏“开启快速备份”；是否开启快速备份由虚机是否支持cbt决定，如果支持cbt则勾选，否则不勾选。
  
  （2） 如果“自动设置快速备份”选项不勾选，则显示“开启快速备份”；开启快速备份是否勾选由用户决定，不受虚机配置信息的影响。
  
* “开启快速备份”：利用vmware的ctk机制，只传输实际使用或改变的数据，不勾选则只能进行整盘备份；
* “支持Lan Free”：在LAN-FREE模式可用时，使用san方式传输；
* “删除备份数据”：删除规则时将备份的数据删除；
* “开启静默快照”：做快照的时候，暂停虚机，保证数据连续和一致，只限制启动的虚机使用；

### 备份策略 {#-3}

![](/assets/V6.120181225171242.png)

* “一次性任务 开始时间”：备份一次，开始的时间；  

  （1） 一次任务/周期任务，任务开始运行时间以npsvr系统时间为准 ；（建议部署时将控制机和npsvr的系统时间保持一致）；  
  
  （2） 一次任务，开始日期不能填写早于今天的日期；  
  
  （3） 一次任务，如果开始时间早于当前时间\(当天\)，则立即执行；
  

* “周期性任务”：设置备份任务周期性执行，添加周期性任务界面

![说明: 1](/assets/V6.120181225171345.png)

* “数据保留期限”：范围0-64，且为整数；只针对周期性任务有效；

* “周期性任务”：点击添加任务，选择策略类型，备份方式（全备份，增量备份，差异备份），运行时间（可以设置多个）；


关于数据保留期限的说明：  

（1） 如果只设置了一条全备，如果备份完成之后，中间点击了立即执行增量，那么超过数据保留期限会将之前的全备数据删除，剩下单独的增量数据将无法做恢复任务；  

（2） 当天的备份任务完成之后，才开始删除过期的数据\(超过数据保留期限的数据\)；  

（3） 如果新的备份失败，则过期的数据不删除\(超过数据保留期限的数据\)；  

（4） 举例：数据保留0天，就是只保留今天的数据，数据保留1天，就是保留今天和昨天的数据； 
 
（5） 举例：数据保留0周，就是保留本周的周一到周日的数据，每个周一为一周的起始，周一到周日为一周；

（6） 举例：假设数据保留0天，策略选择全备和增量备份，第2天增量备份执行完后，开始删除前一天的数据，当天增量所依赖的全备数据(前一天的)会被保留下来，当天增量所依赖的增量数据(前一天的)会被合并到第2天的第一份增量数据中；


关于全备和增量备份/差异备份策略的说明：  

（1） 备份策略最多只能加2条；  

（2） 不能同时添加增量备份和差异备份；  

（3） 备份策略选择每周/每月/每季时，增量/差异备份的执行时间必须和全备的执行时间一致；  

（4） 备份策略选择了每天，就不能再选每周/每月/每季，其他同理；  

（5） 增量备份时，如果获取cbt失败，增量备份会转换为全备，差异备份也是一样；

（6） 如果第一次备份是增量备份，即增量备份先于全备执行，增量备份会转换为全备，差异备份也是一样；

（7） 针对一个备份任务，如果旧的备份还在排队中，或者还没执行完，到新的备份执行时间了，则新的这次备份任务会被略过；

### 带宽控制 {#-3}

![说明: 1](/assets/V6.120181225171519.png)

![说明: 1](/assets/V6.120181225172052.png)

当在某些情况下，用户想限定带宽的使用，可以通过带宽控制来实现。 
选定某个想要限制带宽的时间段，点击单选框“限制带宽”，跳出窗口可以选择限制的带宽范围，其中0代表停止传输，就是说在这个时间段内不传输数据，备份进度会维持在当前进度。
流量图中实时流量图计算得出的带宽，由于计算方法的原因，和这里的带宽会有误差。

### 备份规则列表 {#-4}

![说明: 1](/assets/V6.11811051714.png)

备份规则包含如下状态：

* “启动”：备份规则开始启动；
* “空闲”：非周期性备份任务，在npsvr或备机繁忙的情况下备份规则状态显示为“空闲”，周期性备份任务，在备份规则运行但没有备份数据时，备份规则状态显示为“空闲”；
* “备份准备”：准备开始备份数据；
* “备份虚拟机配置”：备份虚拟机配置信息到备机；
* “查询变化数据”：计算变化块并保存到备机；
* “检查数据”：检查备机数据的状态，是否已经存在以前备份的版本，如果没有，则初始化备份目录；如果有，返回最后备份的版本信息，新备份与旧备份建立父子关系；
* “执行中”：显示备份数据进度百分比；
* “停止”：规则停止；
* “未知”：npsvr或备机宕机出现未知状态；
* “已完成”：数据备份完成；

备份规则操作栏按钮，从左到右如下：

* “规则列表”：查看组内虚机列表和流量图。流量图默认展示第一条虚机的流量，当选择组内其他虚机时切换显示流量图，这里注意，选择虚机前面的复选框和流量图的显示没有关系，直接选择某一行即可切换流量图，页面如下：

![说明: 1](/assets/V6.11811051757.png)

组内虚机备份完成后，页面显示如下：

![说明: 1](/assets/V6.11811051841.png)

点击“规则列表”后，操作栏按钮包含：  
启动规则：启动此虚机的规则；  
停止规则：停止此虚机的规则；  
删除规则：删除此虚机的规则；  
即时恢复：创建此虚机的即时恢复任务；  
![说明: 1](/assets/V6.120181225174324.png)

瞬时恢复：创建此虚机的瞬时恢复任务；  
![说明: 1](/assets/V6.11811051845.png)

立即执行：立即执行此虚机的全备份，增量备份和差异备份；  
查看日志：查看此虚机的备份日志；  
![说明: 1](/assets/V6.11811051758.png)

修改规则：修改此虚机的设置，只能修改备份策略；  
![说明: 1](/assets/V6.11811051759.png)

查看统计信息：查看此虚机的备份统计信息；  
![说明: 1](/assets/V6.11811051918.png)

“备份统计”：针对这个虚机，柱状图和饼状图显示备份任务成功和失败的次数；  
“备份数据量”：针对这个虚机，备份任务备份了多少数据；  
“未查看错误数”：针对这个虚机，如果有备份失败的任务，在“未查看错误数”右方显示失败的个数，查看之后，“未查看错误数”值清零；点击“未查看错误数”后面的箭头，可显示备份成功的任务和失败的任务统计信息，如下图：

![说明: 1](/assets/V6.11811051919.png)

* “开启组内所有规则”：开启组内所有规则；
* “停止组内所有规则”：停止组内所有规则；
* “删除规则”：删除备份规则；
* “组恢复”：创建组恢复任务，页面如下：

![说明: 1](/assets/V6.11811051848.png)

* “修改规则”：修改备份规则，只能修改备份策略，页面如下：

![说明: 1](/assets/V6.11811051924.png)

* “添加新虚机”：在现有虚机的基础上，再添加更多的虚机到现有备份规则，添加新虚机时，高级设置和备份策略不能修改，页面如下：

![说明: 1](/assets/V6.11811051926.png)

* “查看统计信息”：查看当前备份规则的任务统计信息，页面如下：

![说明: 1](/assets/V6.11811051928.png)

“备份统计”：针对这个备份规则，柱状图和饼状图显示备份任务成功和失败的次数，柱状图是对近一周/近一月/近一年的统计，饼状图是所有时间的统计；  
“备份数据量”：针对这个备份规则，备份任务备份了多少数据；  
“未查看错误数”：针对这个备份规则，如果有备份失败的任务，在“未查看错误数”右方显示失败的个数，查看之后，“未查看错误数”值清零；点击“未查看错误数”后面的箭头，可显示备份成功的任务和失败的任务统计信息，如下图：

![说明: 1](/assets/V6.11811051929.png)

注：

（1）如果一个虚机已经加了备份规则，再添加其他规则时，选择虚机时，会在此虚机后标记(已备份)，且不能再选择此虚机；

（2）在选择虚机时，鼠标移至虚拟平台名称，后面会显示出一个Refresh按钮，点击此按钮，可重新获取虚拟平台的虚机列表；

（3）当一个备份规则存在与之关联的恢复任务时，则此备份规则不能被删除；


**注意**

* 可根据客户需求可自行定义全局的task数量，在备机软件的安装目录etc目录下新建system.conf文件，编辑system.conf文件，添加bk\_tsk\_thd=n，n为总的最大任务并发数，默认为8，最多同时只能有8条任务在执行，包含虚机备份任务，恢复任务，迁移任务(不包含瞬时恢复任务)；
* 备机软件的安装目录etc目录下system.conf文件中的i2vp_transbuffer参数，为备机与esxi之间每次传输的数据块大小，默认是4M；
* ESXI的传输量总和不能超过32M，system.conf 中 bk\_tsk\_thd \* i2vp\_transbuffer 的总数不能超过32. 
* 添加无代理备份的任务数大于全局的task数量的最大值时，debugctl.exe back task查看任务状态为pending状态，如下图：

![说明: 3](/assets/V6.036973.png)

* 控制机管理界面pending状态任务显示如下：

![说明: 2](/assets/V6.036999.png)

* npsvr.ini配置文件中的Max\_ThreadNum\_PerHost参数，控制每个esxi主机的最大并发执行规则的数目，默认值为4，此参数受限于bk\_tsk\_thd参数的值；
* 不支持包含独立磁盘的虚机的备份；


**注意**

在备份规则运行中，如果备机网络断开，在vSphere(Vcenter)中删除虚机快照，此时会提示磁盘需要整合，然后手动进行磁盘整合，这时会提示文件被锁定，磁盘整合失败，这个问题解决方法有三种：

* 使用ESXI Shell在ESXi中重新启动管理代理程序；

  （1） 以root用户身份SSH登录ESXI Shell；
  
  （2） 执行命令：services.sh restart；
  
  （3） 可以正常进行磁盘整合；
  
* 存储迁移，在vSphere中选择整合失败的虚机，点击迁移，选择更改数据存储，此方法不受虚机状态影响，但有可能会迁移失败；

* 杀掉占用的进程，执行命令：vmkvsitools lsof | grep Virtual_Machine_Name，查看进程PID, 使用命令中止进程kill -9 PID杀掉占用的进程，虚机会重新配置，可以正常进行磁盘整合；
## 虚机备份

### 添加备份规则 {#-0}

控制机管理界面，通过虚拟化支持-&gt;虚机备份，来添加/编辑/删除虚机备份规则，备份规则添加/编辑页面如下：

### 基本设置{#-4}

![](/assets/V6.118042702.png)

*   “名称”：客户命名的名称，便于管理；
*   “虚拟平台”：已经注册的虚拟平台；
*   “虚拟机”：所选虚拟平台上所有虚机，可同时添加多个虚拟机；
*   “灾备机”：已经注册的备机；
*   “灾备机目标路径”：选择灾备机存储备份数据的目录；

### 高级设置{#-3}

![](/assets/V6.118042707.png)

* “开启快速备份”：利用vmware的ctk机制，只传输实际使用或改变的数据，不勾选则只能进行整盘备份；
* “支持Lan Free”：在LAN-FREE模式可用时，使用san方式传输；
* “删除备份数据”：删除规则同时删除备份数据；
* “开启静默快照”：做快照的时候，暂停虚机，保证数据连续和一致，只限制启动的虚机使用；

### 备份策略 {#-1}

![](/assets/V6.118042705.png)

* “一次性任务 开始时间”：备份一次，开始的时间；
* “周期性任务”：设置备份任务周期性执行，添加周期性任务界面

![说明: 1](/assets/V6.118042706.png)

* “数据保留期限”：最大是64，且为正整数；
* “周期性任务”：点击添加任务，选择策略类型，备份方式（全备，增量，差异），运行时间（可以设置多个）； 

### 备份规则列表 {#-2}

![说明: 1](/assets/V6.11811051714.png)

备份规则包含如下状态：

*   “启动”：备份规则开始启动；
*   “空闲”：非周期性备份任务，在npsvr或备机繁忙的情况下备份规则状态显示为“空闲”，周期性备份任务，在备份规则运行但没有备份数据时，备份规则状态显示为“空闲”；
*   “备份准备”：准备开始备份数据；
*   “备份虚拟机配置”：备份虚拟机配置信息到备机；
*   “查询变化数据”：计算变化块并保存到备机；
*   “检查数据”：检查备机数据的状态，是否已经存在以前备份的版本，如果没有，则初始化备份目录；如果有，返回最后备份的版本信息，新备份与旧备份建立父子关系；
*   “执行中”：显示备份数据进度百分比；
*   “停止”：规则停止；
*   “未知”：npsvr或备机宕机出现未知状态；
*   “已完成”：数据备份完成；

备份规则操作栏按钮，从左到右如下：

*   “规则列表”：查看组内虚机列表和流量图，流量图默认展示第一条虚机的流量，当选择组内其他虚机时切换显示，页面如下：

![说明: 1](/assets/V6.11811051757.png)

备份完成后，页面显示如下：

![说明: 1](/assets/V6.11811051841.png)

点击“规则列表”后，操作栏按钮包含：
启动规则：启动此虚机的规则；
停止规则：停止此虚机的规则；
删除规则：删除此虚机的规则；
即时恢复：创建此备份的即时恢复任务；
![说明: 1](/assets/V6.11811051844.png)

瞬时恢复：创建此备份的瞬时恢复任务；
![说明: 1](/assets/V6.11811051845.png)

立即执行：立即执行此虚机的全备份，增量备份和差异备份；
查看日志：查看此虚机的备份日志；
![说明: 1](/assets/V6.11811051758.png)

修改规则：修改此虚机的设置，只能修改备份策略；
![说明: 1](/assets/V6.11811051759.png)

查看统计信息：查看此虚机的备份统计信息；
![说明: 1](/assets/V6.11811051918.png)

“备份统计”：针对这个虚机，柱状图和饼状图显示备份任务成功和失败的次数；  
“备份数据量”：针对这个虚机，备份任务备份了多少数据；  
“未查看错误数”：针对这个虚机，如果有备份失败的任务，在“未查看错误数”上方显示失败的个数，查看之后，“未查看错误数”值清零；

点击“未查看错误数”后面的箭头，可显示备份成功的任务和失败的任务统计信息，如下图：  
![说明: 1](/assets/V6.11811051919.png)

*   “开启组内所有规则”：开启组内所有规则；
*   “停止组内所有规则”：停止组内所有规则；
*   “删除规则”：删除规则；
*   “组恢复”：创建组恢复任务，恢复到原虚拟机，页面如下：

![说明: 1](/assets/V6.11811051848.png)


*   “修改规则”：修改备份规则，只能修改备份策略，页面如下：

![说明: 1](/assets/V6.11811051924.png)

*   “添加新虚机”：在现有虚机的基础上，再添加更多的虚机到现有备份规则，添加新虚机时，高级设置和备份策略不能修改，页面如下：

![说明: 1](/assets/V6.11811051926.png)

*   “查看统计信息”：查看当前备份规则的任务统计信息，页面如下：

![说明: 1](/assets/V6.11811051928.png)

点击“未查看错误数”后面的箭头，可显示备份成功的任务和失败的任务统计信息，如下图：
![说明: 1](/assets/V6.11811051929.png)


**注意：**

选择完备份点才能显示备份点信息。

**注意**：

1.  可根据客户需求可自行定义全局的task数量，在软件的安装目录etc目录下新建system.conf文件，编辑system.conf文件添加bk_tsk_thd=n，n指可建立全局的task数量的最大值。默认情况下，全局的task数量为8. 
2.  添加无代理备份的任务数大于全局的task数量的最大值时，debugctl.exe back task查看任务状态为pending状态，如下图：

![说明: 3](/assets/V6.036973.png)

控制机管理界面pending状态任务显示如下：

![说明: 2](/assets/V6.036999.png)

备份规则 迁移规则 恢复规则的task数总和不能大于bk_tsk_thd设置的值；

**注意**
1. esxi的传输量总和不能超过32M,system.conf 中 bk_tsk_thd * i2vp_transbuffer 的总数不能超过32;

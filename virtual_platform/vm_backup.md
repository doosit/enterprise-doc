## 虚机备份

### 添加备份规则 {#-0}

控制机管理界面，通过 虚拟化支持-&gt;虚机备份，来添加/编辑备份规则，备份规则添加/编辑页面如下：

![](/assets/V7.1.2019011501.png)

*   “启用模板”： 客户可以选择自己已经保存的模板，便于节省时间；
*   “名称”：客户命名的名称，便于管理；
*   “虚拟平台”：已经注册的虚拟平台；
*   “虚机名称”：所选虚拟平台上所有虚机，可同时添加多个虚拟机；
*   “灾备机”：已经注册的备机；
*   “灾备机目标路径”：选择灾备机存储备份数据的目录；
*   “保存模板”：将已经设置好的选项保存下来，便于下次直接使用；


### 高级设置{#-3}

![](/assets/V7.120190325122449.png)

* “开启快速备份”：利用vmware的ctk机制，只传输实际使用或改变的数据，不勾选则只能进行整盘备份；

* “支持Lan Free”：在LAN-FREE模式可用时，使用san方式传输；

* “删除备份数据”：删除规则时将备份的数据删除；

* “静默快照支持”：做快照的时候，暂停虚机，保证数据连续和一致，只限制启动的虚机使用；

* “开启内存快照”：做快照的时候，生成内存快照，会备份内存数据，利用内存快照恢复，能够让恢复出来的虚拟机处于当时备份时候的状态，即开机状态加相同的内存内容；关机状态不支持内存快照，关机状态是普通快照；

* “开启压缩设置”：对备份数据进行压缩然后保存，备份数据会占用较小的磁盘空间；

### 备份策略设置 {#-1}

在控制机管理界面，通过 虚拟化支持-&gt;虚机备份-&gt;备份策略，设置页面如下：

![](/assets/V7.1.2019011503.png)

* “一次性任务 开始时间”：备份一次开始的时间；

* “周期性任务”：设置备份任务周期性执行，添加周期性任务界面。策略类型包括：每日、每周、每月，备份方式可设置：全备、增量、差异。

![](/assets/V7.1.20190325102314.png)

* “添加计划”：点击添加计划，选择策略类型，备份方式（全备，增量，差异），运行时间（可以设置多个）； 
* “备份保留”：数据保留期限，范围1-64，且为整数；

### 带宽控制设置 

![](/assets/V7.1.2019011505.png)


### 备份规则列表 {#-2}

![](/assets/V7.120190510162904.png)

添加周期性任务，状态显示为空闲，等待下次调用；
添加非周期性任务，状态显示为完成；

备份规则包含如下状态：

* “启动”：备份规则开始启动；
* “排队中”：任务正在排队；
* “获取虚机配置”：获取虚拟机配置信息到备机；
* “查询变化数据”：计算变化块并保存到备机；
* “检查数据”：检查备机数据的状态，是否已经存在以前备份的版本，如果没有，则初始化备份目录；如果有，返回最后备份的版本信息，新备份与旧备份建立父子关系；
* “传输中”：显示备份数据进度百分比；
* “停止”：规则停止；
* “失效”：npsvr或备机宕机出现失效状态；
* “完成”：数据备份完成；
* “空闲”：非周期性备份任务，在npsvr或备机繁忙的情况下备份规则状态显示为“空闲”，周期性备份任务，在备份规则运行但没有备份数据时，备份规则状态显示为“空闲”；


针对备份规则可用的操作，从左到右如下：

*   “启动”：启动规则；
*   “停止”：停止规则；
*   “删除”：修改规则；
*   “普通恢复”：可直接添加/编辑恢复原虚机或新建虚机的恢复任务，点击普通恢复，页面如下图所示：

![](/assets/V7.1.2019011507.png)

**注意：**

选择完备份点才能显示备份点信息。

*   “瞬时恢复”：(针对linux)可直接添加/编辑恢复原虚机或新建虚机的恢复任务
*   “查看日志”：查看此虚机的规则日志；
*   “查看统计信息”：查看此虚机的备份统计信息；

组操作栏可用操作：
*   “查看规则”：查看备份规则；
*   “组恢复”：可直接添加/编辑恢复原虚拟机，点击组恢复，页面如下：

![](/assets/V7.1.2019011508.png)

* “查看统计信息”：查看此规则的备份统计信息；
* “组启动/组停止/组删除”：启动，停止，删除组规则；

**注意**：

*  可根据客户需求可自行定义全局的task数量，在软件的安装目录etc目录下新建system.conf文件，编辑system.conf文件添加bk_tsk_thd=n，n指可建立全局的task数量的最大值。默认情况下，全局的task数量为4。

   备份规则 迁移规则 保护规则 恢复规则的task总和 不能大于 bk_tsk_thd 设置的值。
   
   esxi的传输量总和不能超过32M,system.conf  中  bk_tsk_thd * i2vp_transbuffer 的总数不能超过32。

*  添加无代理备份的任务数大于全局的task数量的最大值时，debugctl.exe back task查看任务状态为pending状态，如下图：

![说明: 3](/assets/V6.036973.png)

*  控制机管理界面pending状态任务显示如下：

![说明: 2](/assets/V7.036999.png)

## 虚机复制

### 添加虚机复制规则 {#-0}

控制机管理界面，通过 虚拟化支持-&gt;虚机复制，来添加/查看虚机复制规则，虚机复制规则添加/查看页面如下：

### 基本设置 {#-1}

![说明: 1](/assets/V7.020190109175014.png)

*   “启用模板”：客户可以选择自己已经保存的模板，便于节省时间；
*   “名称”：客户命名的保护规则名称，便于管理；
*   “源平台”：已经注册的虚拟平台；
*   “虚机名称”：所选源平台上所有虚机；
*   “灾备机”：已经注册的备机；
*   “临时目录”：保护过程中数据落盘的目录；
*   “目标平台”：已经注册的虚拟平台；
*   “数据中心”：已经注册的目标平台的数据中心；
*   “主机名称”：已经注册的目标平台主机名称；
*   “存储” ： 已经注册的目标平台的数据存储；
*   “保存模板”：将已经设置好的选项保存下来，便于下次直接使用；

### 同步策略 {#-1}

![说明: 1](/assets/V7.020190109175142.png)

*   “开启自动同步”：开启周期性虚机同步；
*   “策略类型”：策略类型分为“每小时” “每天” “每周” “每月”；
*   “间隔时间”：策略类型为“每小时”专用，上次任务开始与下次任务开始中间的时间差；   
*   “开始时间”：任务开始时间；
*   “保留历史”：保留的虚机快照个数；

### 高级设置 {#-2}

![说明: 1](/assets/V7.020190109175334.png)

*   “开启快速传输”：利用vmware的ctk机制，只传输实际使用或改变的数据；
*   “静默快照支持”：做快照的时候，暂停虚机，保证数据连续和一致，只限制启动的虚机使用；
*   “支持Lan Free”：在LAN-FREE模式可用时，使用san方式传输；
*   “删除规则时删除目标虚机”：删除规则时复制的目标虚机被删除；

### 带宽控制 {#-2}

![说明: 1](/assets/V7.020190109175802.png)

当在某些情况下，用户想限定备机使用的带宽，可以通过带宽控制来实现。 
选定某个想要限制带宽的时间段，点击单选框“限制带宽”，跳出窗口可以选择限制的带宽范围，其中0代表停止传输，就是说在这个时间段内不传输数据，备份进度会维持在当前进度。

### 复制规则列表 {#-3}

虚机复制规则列表页面如下：

![说明: 1](/assets/V7.020190109180038.png)

虚机复制规则包含如下状态：

*   “启动”：规则开始启动；
*   “排队中”：任务正在排队；
*   “创建新虚机”：开始创建虚拟机；
*   “获取虚机配置”：获取虚拟机配置信息到备机；
*   “查询变化数据”：计算变化块并保存到备机；
*   “执行中”：显示虚机复制进度百分比；
*   “停止”：规则停止；
*   “失效”：npsvr或备机宕机出现失效状态；
*   “完成”：虚机复制规则完成；
*   “空闲”：非周期性任务，在npsvr或备机繁忙的情况下规则状态显示为“空闲”，周期性任务，在规则运行但没有传输数据时，规则状态显示为“空闲”；
*   “恢复快照”：将目标虚机转到之前创建的快照；
*   “快照清除”：目标虚机转到之前创建的快照之后，将快照移除；
*   “临时切换”：虚机临时切换到某个快照时间点，可以回切；
*   “永久切换”：虚机永久切换到某个快照时间点，不可回切；

针对虚机复制规则可用的操作，从左到右如下：

*   “启动”：启动此虚机的规则；
*   “停止”：停止此虚机的规则；
*   “删除”：删除此虚机的规则；
*   “查看日志”：查看此虚机的日志；
*   “切换”：切换此虚机到某个快照时间点；
*   “回切”：回切虚机；
*   “查看统计信息”：查看此虚机的统计信息；

![说明: 1](/assets/V7.020190109181122.png)

组操作栏可用操作如下：

*   “查看配置”：查看规则的配置；
*   “查看统计信息”：查看规则的统计信息；

注：

（1）如果一个虚机已经加了虚机复制规则，再添加其他规则时，选择虚机时，会在此虚机后标记(已复制)，且不能再选择此虚机；

（2）在选择虚机时，虚拟平台后面会显示一个刷新按钮，点击此按钮，可重新获取虚拟平台的虚机列表；

（3）虚机复制规则第一次是整机复制，后面全部是增量复制；

**注意**：

* 可根据客户需求可自行定义全局的task数量，在备机软件的安装目录etc目录下新建system.conf文件，编辑system.conf文件，添加bk\_tsk\_thd=n，n为总的最大任务并发数，默认为4，最多同时只能有4条任务在执行，包含虚机备份任务，恢复任务，迁移任务\(不包含瞬时恢复任务\)；

* 备机软件的安装目录etc目录下system.conf文件中的i2vp\_transbuffer参数，为备机与esxi之间每次传输的数据块大小，默认是4M；

* ESXI的传输量总和不能超过32M，system.conf 中 bk\_tsk\_thd \* i2vp\_transbuffer 的总数不能超过32.

* 添加无代理备份的任务数大于全局的task数量的最大值时，debugctl.exe back task查看任务状态为pending状态，
如下图：

![说明: 3](/assets/V6.036973.png) 
  
控制机管理界面pending状态任务显示如下： 
  
![说明: 2](/assets/V7.036999.png)

* npsvr.ini配置文件中的Max\_ThreadNum\_PerHost参数，控制每个esxi主机的最大并发执行规则的数目，默认值为4，此参数受限于bk\_tsk\_thd参数的值；

* 不支持包含独立磁盘的虚机的备份；




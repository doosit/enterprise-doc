## 虚机复制

### 添加复制规则 {#-0}

虚拟机复制，目标虚拟平台上也会有原平台一样的虚拟机，并且源机数据会根据同步策略，定时同步到目标虚机。

控制机管理界面，通过 虚拟化支持-&gt;虚机复制，来添加/查看复制规则，复制规则添加/查看页面如下：

![说明: 1](/assets/V7.1.2019011518.png)

*   “启用模板”：客户可以选择已经保存的模板，便于节省时间；
*   “名称”：虚机复制规则名称；
*   “源平台”：被复制的虚机所在的虚拟平台；
*   “虚机名称”：被复制的虚机的名称；
*   “灾备机”：灾备机，用来保存虚机的一些配置信息；
*   “临时目录”：灾备机的临时目录，用来保存虚机的一些配置信息；
*   “目标平台”：虚机被复制到的目标平台；
*   “数据中心”：目标平台的数据中心；
*   “主机名称”：目标平台的主机名称；
*   “存储”：目标平台的数据存储；
*   “保存模板”：将已经设置好的选项保存成模板，便于下次直接启用；

### 同步策略 {#-1}

在控制机管理界面，通过 虚拟化支持-&gt;虚机复制-&gt;同步策略，设置页面如下：

![说明: 1](/assets/V7.120190325122817.png)

*   “开启自动同步” ：开启周期性增量保护；
*   “策略类型”：策略类型分为“每小时” “每天” “每周” “每月”；
*   “间隔时间”：策略类型为“每小时”专用，上次任务开始与下次任务开始中间的时间差；
*   “运行时间”：策略类型为“每天” “每周” “每月” 专用，是每次任务的开始时间；
*   “开始时间”：任务开始时间；
*   “保留历史”：保留的虚机快照个数；


### 高级设置 {#-2}

在控制机管理界面，通过 虚拟化支持-&gt;虚机复制-&gt;高级，设置页面如下：

![说明: 1](/assets/V7.120190325122831.png)

*   “开启快速传输”：利用vmware的ctk机制，只传输实际使用或改变的数据；
*   “静默快照支持”：做快照的时候，暂停虚机，保证数据连续和一致，只限制启动的虚机使用；
*   “支持Lan Free”：在LAN-FREE模式可用时，使用san方式传输；
*   “删除目标虚机”：删除规则时复制的目标虚机被删除；

注：虚机复制规则第一次是全备，后面是增量备份。

### 带宽控制

![说明: 1](/assets/V7.1.2019011521.png)

### 复制规则列表 {#-3}

配置好规则提交后运行如下：

![说明: 1](/assets/V7.120190404151703.png)

虚机复制规则包含如下状态：

*   “启动”：规则开始启动；
*   “排队中”：任务正在排队；
*   “创建新虚机”：开始创建虚拟机；
*   “获取虚机配置”：获取虚拟机配置信息到备机；
*   “查询变化数据”：计算变化块并保存到备机；
*   “传输中”：显示虚机复制进度百分比；
*   “停止”：规则停止；
*   “失效”：npsvr或备机宕机出现失效状态；
*   “完成”：虚机复制规则完成；
*   “空闲”：非周期性任务，在npsvr或备机繁忙的情况下规则状态显示为“空闲”，周期性任务，在规则运行但没有传输数据时，规则状态显示为“空闲”；
*   “恢复快照”：将目标虚机转到之前创建的快照；
*   “快照清除”：目标虚机转到之前创建的快照之后，将快照移除；
*   “临时切换”：虚机临时切换到某个快照时间点，可以回切；
*   “永久切换”：虚机永久切换到某个快照时间点，不可回切；

针对规则可用的操作，从左到右如下：

*   “启动”：启动此虚机的规则；
*   “停止”：停止此虚机的规则；
*   “删除”：删除此虚机的规则；
*   “查看日志”：查看此虚机的日志；
*   “切换”：切换此虚机到某个快照时间点；
*   “回切”：回切虚机到切换之前的状态；
*   “查看统计信息”：查看此虚机的统计信息；

组操作栏可用操作如下：

*   “查看配置”：查看规则的配置；
*   “查看统计信息”：查看规则的统计信息；
*   “组启动/组停止/组删除”：启动，停止，删除组规则；

注：Hyper-V平台不支持虚机复制。

**注意**：

*  可根据客户需求可自行定义全局的task数量，在软件的安装目录etc目录下新建system.conf文件，编辑system.conf文件添加bk_tsk_thd=n，n指可建立全局的task数量的最大值。默认情况下，全局的task数量为8。

   备份规则 迁移规则 保护规则 恢复规则的task总和 不能大于 bk_tsk_thd 设置的值。
   
   esxi的传输量总和不能超过32M,system.conf  中  bk_tsk_thd * i2vp_transbuffer 的总数不能超过32。

*  添加无代理备份的任务数大于全局的task数量的最大值时，debugctl.exe back task查看任务状态为pending状态，如下图：

![说明: 3](/assets/V6.036973.png)

## 创建复制规则

复制规则，即数据从工作机到灾备机的灾备“通道“。数据灾备的主要实现手段是通过将数据以及相关的变化实时地从工作机复制到灾备机。i2灾备软件以字节为最小单位，将数据的变化部分，而不是整个数据按序地复制到异地的灾备中心，从而保证数据传输的高效、数据的严格一致性。

选择”规则管理-复制规则”，复制规则创建窗口如下：

![](/assets/业务组.png)

* “名称“：客户命名的复制规则名称，便于管理；

* “节点组”：选择节点组，方便工作机，灾备机节点选择；

* “工作机”：系统自动列出该用户创建的所有工作机节点；

* “灾备机“：系统自动列出所有灾备机节点；

* “业务组”：确定创建的复制规则所在组别，方便之后统一管理

* “文件类型“：用户可以指定只保护某些后缀名的文件，或者排除某些后缀名的文件。

* “规则自动启动“：默认选中，规则提交，自动开始镜像。如果不选中，规则提交后，为停止状态。用户需要手动启动该规则，或者设置预约启动，到达设置的时间点后，规则会自动启动。

如果映射类型为 一对一，则文件映射表类似如下：

![](/assets/V7.020627.png)

* “映射类型“：i2软件提供两种目录映射方式：多对一，一对一； 
  ```
  “多对一”方式表示所有的工作机的源目录和文件都复制到灾备机的单一目录下。为了防止同名文件覆盖，灾备机会保存工作机目录和文件的完整路径。比如，上述例子工作机需要保护的目录为：C:\java\, C:\oracle\product\10.2.0\oradata\, 则灾备机上的目录为：E:\bak\C\java\, E:\bak\C\oracle\product\10.2.0\oradata\。
  “一对一”方式表示工作机的源目录和文件一 一对应到灾备目录，灾备机不再需要保存工作机的完整路径。上述一对一的例子，工作机上的C:\java\下的内容和灾备机下C:\java\目录下的内容是完全相同的。
  ```
* “要复制的文件和目录“：在工作机是linux平台下，系统会将用户创建工作机时选择的灾备目录在此列出，用户可以做进一步的优化，如排除个别不需要的文件或者目录。如工作机是windows平台，则用户可在此自由选择需要灾备的目录。

* “不要复制的文件和目录“：不要复制的文件和目录表格的文件和目录通常是映射表中工作机源目录下的文件或者子目录。由该表指定的文件和目录不会被i2软件监控，以及复制到灾备机上。

**特别说明：**

```
当linux操作系统作为此时的灾备机时，linux在添加节点的时候选择了卷组方式时，linux不能在选择一对一的映射类型，且此时所选择的linux目标路径必须为空。
```

提交之后，在复制规则列表窗口可以看到如下的信息：

![](/assets/V7.1.2019011016.png)

复制规则会将要灾备的数据一次性同步到灾备机上，此过程称为镜像。复制规则在真正开始数据传输之前首先统计需要同步的文件数量和大小, 以此来计算镜像的进度。镜像时间的长短取决于初始数据的大小、网络的速度以及镜像的算法，在状态栏会显示镜像的进度。

当镜像完成后，复制规则进入“复制“状态，如下：

![](/assets/V7.1.2019011015.png)

i2灾备软件定义了如下复制规则的状态：

“镜像”：将工作机上的数据一次拷贝到灾备机上；

“复制”：i2持续监测用户数据的变化，将变化的数据复制到灾备机；

“异常”：一些特殊的事件导致，工作机模块无法将数据复制到灾备机，从而使灾备系统处于不一致的状态；比如，工作机无法连接到灾备机等，绝大多数都是网络导致的；

“失效”：通常“异常”状态会导致规则“失效”，处于“失效”状态的规则无法将数据复制到灾备机；但是i2灾备系统会自动试图在“失效”状态中恢复过来。比如，网络恢复等；

“停止”：表示工作机不会把数据复制到灾备机。有两种情况可能导致复制规则处于“停止”状态：一是用户设置的带宽为0，所以停止复制。当带宽不为0时，复制规则重镜像后自动恢复到有效状态；二是某些事件导致复制规则无法恢复到有效的状态。比如，工作机或者灾备机的磁盘满等，此时的复制规则，只有人工介入才能恢复到正常状态。

“未知”：无法获取到规则信息

“切换”：规则从镜像状态转换到复制状态时的中间状态，时间很短

i2灾备软件会定时刷新该状态信息，复制规则对应的操作有十种，解释为：

![](/assets/V7.201811151510.png)

* “启动”：启动复制规则
* “停止”：停止复制规则
* “修改”：部分属性只有在规则停止的状态下才能对其进行修改。
* “删除”：删除规则，灾备机上的相应数据是否被删除由复制规则的删除策略决定。

更多按钮中依次为：

* “查看日志”：查看规则的日志信息，

* “查看数据占用空间”：查看该规则各项数据占用的磁盘空间情况，如下图：

![](/assets/V7.018042607.png)

* “查看数据流量”：查看规则的实时数据流量，数据复制延迟。

![](/assets/V7.1.2019011017.png)

* “查看孤儿文件”：孤儿文件的说明见复制规则高级属性，可以对孤儿文件进行删除或者下载，如下图。

![](/assets/V7.1.2019011018.png)

* “查看CDP数据”：删除不需要的CDP数据以及相关日志

![](/assets/V7.1.2019011019.png)

* “立即快照”：进入立即快照界面，点击“立即快照”按钮支持快照功能

![](/assets/V7.201811151512.png)

## 创建集群规则

控制机界面：进入规则管理-&gt;复制规则，点击“集群规则”，如下图：

![](/assets/V7.201811151515.png)

点击“新建”，见下图：

![](/assets/集群.png)

创建集群的复制规则流程与普通的复制规则差不多，区别在于这里只能选择集群管理已创建的集群，“灾备机目标路径”选择灾备机的存放目录，提交后即开始镜像-复制，效果见下图：

![](/assets/V7.1.2019011409.png)


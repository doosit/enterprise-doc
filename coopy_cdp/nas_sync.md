## Nas同步规则

nas同步规则是针对共享目录提供数据保护，以相对路径存储的方式同步到备端，同步类型可分为直接同步和同步主机同步两种同步方式

直接同步：在生产机上操作时，生产机将变化的数据，以镜像的方式传输到备端，如果是大量操作会存在事件合并的情况。

同步主机同步：进一步降低生产机的压力、当多台生产机同时挂载此路径时，在生产机上操作数据时，会将此操作以事件的方式发送给同步主机，当存在大量操作，存在事件合并，由同步主机将数据同步到灾备机上。

此同步非实时数据捕获传输，是以事件的方式同步数据，如当一个文件改变时，或大量数据变化时，数据不会捕获变化的数据，会将此操作以事件的方式记录，之后通过镜像的方式将数据一次性同步到备端

Nas同步分为三种不同的同步方式，具体拓扑流程图如下：

1、同步主机模式发送数据，同步主机需要和服务器挂载相同路径

![img](/assets/v6.2.20180717001.png)

2、服务器直接同步方式

![img](/assets/v6.2.20180717002.png)

3、Windows系统api同步方式

如果操作系统支持系统api的方式，可只在镜像服务器上安装i2软件，其他服务器不需要，此时镜像服务器会自动捕获其他服务器数据的变化，将变化的数据从镜像服务器传输到备份服务器

![img](/assets/v6.2.20180717003.png)

### 基本设置 {#-0}

如下是配置操作界面:

![img](/assets/v7.0.20181009001.png)

* “名称”：为方便管理，给同步规则的名字；

* “同步类型”：同步类型分为同步主机同步和直接同步；

* “工作机”：指定进行Nas同步的主机；

* “源端目录和文件”：添加需要保护的挂载的nas目录或者子目录；

* “同步机”：实际传输数据的机器，需要和源端挂载相同的目录；

* “同步机路径”：对应的工作机的挂载路径，此路径和工作机挂载的应该为同一个目录

* “灾备机”：需要将数据保护到此机器，添加具体路径；

* “灾备机路径”：需要将数据同步到灾备机的具体路径下

### 压缩加密 {#-1}

![img](/assets/v7.0.20181009002.png)

* [复制规则高级属性](coopy_cdp/advance_settings.md)

### 带宽控制 {#-2}

![img](/assets/v7.0.20181009003.png)

* [复制规则高级属性](coopy_cdp/advance_settings.md)

### 比较计划 {#-3}

在控制机管理界面，通过 Nas同步-&gt;Nas同步-&gt;比较计划，设置页面如下：

![img](/assets/v7.0.20181009004.png)

* “开启比较计划”：开启后可以选择校验方式和添加比较策略；

* “校验方式”：可以选择严格校验和时间校验；

* “添加计划”：可以添加比较策略，如下图：

![img](/assets/v7.0.20181009005.png)

* “策略类型”：可以选择“每天” “每周” “每月”；

* “运行时间”：规则开始运行的时间（策略类型为每天时可以选择多个运行时间）；

### Nas规则列表 {#-4}

![](/assets/201903251754.png)

Nas同步单条规则可添加多个工作机，要求工作机挂载相同的nas，保护相同的nas路径，对一条nas同步规则，可操作单条和单个工作机规则

单条规则操作：启动，停止，删除，修改；

单工作机规则：启动，停止，删除，查看日志；

**注意事项：**

```
1、windows有两种事件捕获方式供选择，默认是使用系统API的方式，还有是通过内核模块捕获的方式。
windows使用系统API方式针对共享文件同步时，只要在一台机器上挂载了共享路径，即可监控到所有主机变化的数据，不需要在多台生产机上同时部署，这是一种特殊的部署方式，内核模块捕获方式则没有此特性，需要在所有的生产机上部署。
内核模块捕获方式主要是为了在某些无法支持系统API方式的NAS的情况下使用。

2、linux针对共享文件同步时，只捕获自己主机变化的数据，其他主机变化的数据不会传输。Linux目前只支持nfs挂接的NAS。

3、使用同步主机传输数据时，请确保同步主机和生产机挂载的是同一个nas目录，挂载到生产机和同步主机的挂接点路径可不相同

4、生产主机上NAS规则初始状态是停止，需要点击界面上启动按钮。
同步主机上NAS规则的初始状态是未知， 生产主机上NAS规则启动后，才会把相应的信息发送到同步主机，信息同步后同步主机上才状态显示。

5、NAS同步只会对增量数据做同步，如果需要同步存量数据，请使用复制规则或一致性比较同步来完成镜像。

6、NAS同步使用端口为26841、26843两个端口，如果开启了防火墙，请注意打开端口

7、NAS同步不适合频繁修改的大文件

8、NAS同步不同步文件属性
```



